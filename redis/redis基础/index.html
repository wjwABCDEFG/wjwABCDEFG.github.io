<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.1" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>redis基础 - 小温 blog</title>


    <meta name="description" content="1. 数据存储和查找发展文件：慢，因为全量扫描-&gt;IO，因此慢">
<meta property="og:type" content="article">
<meta property="og:title" content="redis基础">
<meta property="og:url" content="https://wjw.today/redis/redis%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="小温 blog">
<meta property="og:description" content="1. 数据存储和查找发展文件：慢，因为全量扫描-&gt;IO，因此慢">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213028.jpeg">
<meta property="article:published_time" content="2020-10-09T01:23:26.000Z">
<meta property="article:modified_time" content="2021-07-17T13:31:49.905Z">
<meta property="article:author" content="wjw">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213028.jpeg">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717231246.png" alt="redis基础" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="noopener" title="View My GitHub" href="https://github.com/wjwABCDEFG">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-image">
        <span  class="image is-7by1">
            <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213028.jpeg" alt="redis基础">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2020-10-09T01:23:26.000Z">2020-10-09</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/redis/">redis</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    35 分钟 读完 (大约 5324 个字)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span>次访问
                </span>
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                redis基础
            
        </h1>
        <div class="content">
            <h1 id="1-数据存储和查找发展"><a href="#1-数据存储和查找发展" class="headerlink" title="1. 数据存储和查找发展"></a>1. 数据存储和查找发展</h1><p><strong>文件</strong>：慢，因为全量扫描-&gt;IO，因此慢</p>
<a id="more"></a>

<p><strong>mysql</strong>：为什么数据库存东西，因为快，为什么，因为做了分块(datapage)，然后对这些块做了索引，所以我们先查索引，找到对应是哪块，然后只查这一块，就快很多。那要扫描索引？，将索引加载进内存并且采用B+树结构可以避免扫描整个索引。</p>
<p><em>面试题</em>：如果表很大，增删改查会变慢吗？数据量大了，增删改是一定会变慢的。查询：得分场景，即便表很大，但是如果一个客户端发送一个简单的查询请求，索引命中了情况下，查询还是毫秒级的。但是如果高并发情况下，查询是变慢的，因为查询时间应该包括寻址时间和磁盘io时间，即使寻址是毫秒级的，但是由于带宽，吞吐等硬盘限制，高并发场景下会受到硬盘的限制而变得很慢，否则也不会出现分布式微服务上来就是redis这种事情</p>
<p><strong>redis</strong>：综上所述，并发情况下限制主要在硬盘，那所有数据存在内存中呢？那当然快了！还真有这么一种内存型关系数据库：SAP HANA，可是内存它贵呀，动不动就上T的数据存在内存中太烧钱了。redis的产生理念：其实只有一小部分数据频繁被访问（被称为热点数据），很大一部分数据都是不经常用的就存在mysql里，因此使用redis一定要明确使用场景：热点数据。</p>
<br>

<hr>
<h1 id="2-Redis特点"><a href="#2-Redis特点" class="headerlink" title="2. Redis特点"></a>2. Redis特点</h1><p>面试可不要只说一点啊，看我的！</p>
<ul>
<li><p>NoSQL系列，key-value形式，内存数据库：NoSQL是非关系型数据库的统称，redis以键值对的形式存在，在内存中速度会比mysql快几个量级。为什么redis是key-value型的而不是sql形式：不妨根据上面所说的大胆猜测一下，关系型数据库中通常会接触到范式，A表外键为B表的主键，而redis设计初衷就是只存一部分热点数据，因此无法确定是否包含在B中，因此redis应该只关注自身，不关注依赖。</p>
</li>
<li><p>有自己的数据类型，实现了计算向数据移动（这个词就很专业）：有String, Set, List, Hash, Sortedset五种类型，<strong>并且每种类型有自己的本地方法</strong>，对比memcache（所有的value都是string类型并通过json转换），如果需要取出数组第二个元素，memcache需要将整个list字符串返回，调用方拿到数据转换成列表再取第二个元素，redis可以读取list并通过lindex命令取出第二个元素并返回，也就是先计算再io，这种<strong>计算向数据移动</strong>的思想在map-reduce中有体现，可以减少传输的数据量，很快。</p>
</li>
<li><p>工作线程是单线程的，看下面第四点</p>
</li>
</ul>
<br>

<hr>
<h1 id="3-五种数据结构"><a href="#3-五种数据结构" class="headerlink" title="3. 五种数据结构"></a>3. 五种数据结构</h1><blockquote>
<p>api我就不多说了，可以看官方文档/中文文档/菜鸟教程</p>
<p><a href="https://redis.io/commands">https://redis.io/commands</a></p>
<p><a href="https://www.redis.com.cn/commands.html">https://www.redis.com.cn/commands.html</a></p>
<p><a href="https://www.runoob.com/redis/redis-lists.html">https://www.runoob.com/redis/redis-lists.html</a></p>
</blockquote>
<h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><p>String数据结构是简单的key-value类型，value其实不仅可以是String，也可以是数值和Bitmap。 使用场景包括 <strong>常规计数：微博数，粉丝数</strong>等</p>
<h3 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h3><p>重点说一下这个，有一些特殊的场景运用</p>
<ul>
<li>SETBIT key offset value</li>
</ul>
<p>8个位为一个字节，SETBIT key1 6 1为00000010，offset为从左往右从0开始数</p>
<p>超过了7，则为第二个字节，SETBIT key2 9 1为00000000 01000000</p>
<ul>
<li>BITCOUNT start end</li>
</ul>
<p>统计有多少个位为1，注意start和end以字节为单位而不是以位为单位</p>
<br>

<p><strong>场景1：统计某个用户某段时间内的登录天数</strong></p>
<p>这个如何用bitmap巧妙完成呢，用户在哪天登录，就将其作为offset，比如用户在第1天和第365天登录</p>
<p>SETBIT wjw 1 1</p>
<p>SETBIT wjw 365 1</p>
<p>统计的时候就可以</p>
<p>BITCOUNT wjw 0 -1</p>
<p>可以计算一下，这个key最多也就占46个字节（46×8=368，因为一个bitmap是8的倍数）</p>
<p><strong>场景2：统计某段时间内的活跃用户数量</strong></p>
<p>key是日期，offset是用户id，value是1</p>
<p>如wjw的用户id是1，whx的用户id是2,那么</p>
<p>SETBIT 20200101 1 1</p>
<p>SETBIT 20200101 2 1</p>
<p>SETBIT 20200102 1 1</p>
<p>也就是wjw在第一天和第二天登录，whx只在第一天登录</p>
<p>那么这两天的活跃用户数量为</p>
<p>BITOP or res 20200101 20200102</p>
<p>BITCOUNT res</p>
<p>得到res等于2</p>
<br>

<h2 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h2><p>hash 特别适合用于<strong>存储对象</strong>，后续操作的时候，你可以直接仅仅修改这个对象中的某个字段的值。 比如我们可以Hash数据结构来<strong>存储用户信息，商品信息</strong>等</p>
<p>底层数据结构如下</p>
<ul>
<li>Redis中的字典使用哈希表作为底层结构实现，每个字典带有两个哈希表，一个平时使用，另一个仅在进行rehash时使用。</li>
<li>Redis使用MurmurHash2算法来计算键的哈希值。</li>
<li>哈希表使用链地址法来解决键冲突。</li>
</ul>
<p>注意：这里和Java的HashMap不同的rehash过程</p>
<ol>
<li>Redis的rehash过程是扩展和收缩，而且还是渐进式的rehash</li>
<li>Redis的字典有两个哈希表ht[0]和ht[1]</li>
<li>为字典的ht[1]哈希表分配空间，如果执行的是扩展操作，那么ht[1]的大小为第一个大于等于ht[0].used *2的2^n；如果执行的是收缩操作，那么ht[1]的大小第一个大于等于ht[0].used的2^n。（举个例子，ht[0]的长度为10，那么扩展就是2^5的32，如果是压缩的话2^4=16）</li>
<li>如果ht[0]的键值非常多的话，一次性转移过去，是一个非常耗时的操作哦，因此并非一次性，采取渐进式rehash转移。</li>
</ol>
<br>

<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>list 就是链表，Redis list 的应用场景非常多，也是Redis最重要的数据结构之一，比如<strong>微博的关注列表、粉丝列表、消息列表、评论列表</strong>等功能都可以用Redis的 list 结构来实现。</p>
<p>Redis list 的实现为一个双向链表，即可以支持反向查找和遍历，更方便操作，不过带来了部分额外的内存开销。</p>
<p>另外可以通过 lrange 命令，就是从某个元素开始读取多少个元素，可以基于 list 实现分页查询，这个很棒的一个功能，基于 redis 实现简单的高性能分页，可以做类似微博那种<strong>下拉不断分页</strong>的东西（一页一页的往下走），性能高</p>
<br>

<h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><p>当你需要存储一个列表数据，又不希望出现重复数据时用set，并且set提供了判断某个成员是否在 一个set集合内的重要接口，这个也是list所不能提供的。可以基于 set 轻易实现<strong>交集、并集、差集</strong>的操作</p>
<p><strong>场景1：抽奖</strong></p>
<p>SRANDMEMBER key 3，不重复的随机抽3个</p>
<p>SRANDMEMBER key -3，可重复的随机抽3个</p>
<p><strong>场景2：推荐系统</strong></p>
<ul>
<li><p><strong>交集：共同关注</strong>：在微博应用中，可以将一个用户所有的关注人存在一个集合中，将其所有粉丝存在一个集合。Redis可以非常 方便的实现如<strong>共同关注、共同粉丝、共同喜好</strong>等功能。这个过程也就是求交集的过程，具体命令如下：<code>sinterstore key1 key2 key3</code>将交集存在key1内</p>
</li>
<li><p><strong>差集：可能认识的人</strong>：SDIFF</p>
</li>
<li><p><strong>并集：好友圈</strong>：SUNION</p>
</li>
</ul>
<br>

<h2 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h2><p>和set相比，sorted set增加了一个<strong>权重参数score</strong>，使得集合中的元素能够按score进行<strong>有序</strong>排列。</p>
<p>举例： 在直播系统中，实时排行信息包含直播间在线用户列表，各种<strong>礼物排行榜</strong>，弹幕消息（可以理解为按消息维度的消息排行榜）等信息，适合使用 Redis 中的 SortedSet 结构进行存储。</p>
<p>底层实现是一个跳表SkipList</p>
<blockquote>
<p> 放知乎程序员小灰的两篇文章</p>
<p><a href="https://zhuanlan.zhihu.com/p/53975333">https://zhuanlan.zhihu.com/p/53975333</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/200815425">https://zhuanlan.zhihu.com/p/200815425</a></p>
</blockquote>
<ul>
<li>简单来说跳跃表是一种有序数据结构，它通过在<strong>每个节点中维持多个指向其他节点的指针</strong>，从而达到快速访问节点的目的。</li>
<li>跳跃表平均O(longN)，最坏O(N)复杂度的节点查找</li>
<li>跳跃表有个层的概念：层带有两个属性：<strong>前进指针和跨度</strong>，前进指针用于<strong>访问位于表尾方向的其他节点</strong>，而跨度则记录了<strong>前进指针所指向节点和当前节点的距离</strong>。一般情况下，层越多，查找效率越高。</li>
</ul>
<br>

<hr>
<h1 id="4-Redis的NIO和线程模型"><a href="#4-Redis的NIO和线程模型" class="headerlink" title="4. Redis的NIO和线程模型"></a>4. Redis的NIO和线程模型</h1><p>redis是单线程的还是多线程的？</p>
<p>用户对redis操作是单线程的（worker单线程），redis 6.x支持多线程，但是！！！这叫io threads，用于处理用户的请求，实际操作还是单线程的。</p>
<p>5.x和6.x对比如下</p>
<p><img src="images/loading.gif" data-original="https://s3.ax1x.com/2020/12/06/DX1ubq.png" alt=""></p>
<p>可以看到在6.x的时候worker线程（计算那里）还是单线程，但快了不少。</p>
<h2 id="4-1-为什么是单线程的"><a href="#4-1-为什么是单线程的" class="headerlink" title="4.1 为什么是单线程的"></a>4.1 为什么是单线程的</h2><p>因为Redis是基于内存的操作，CPU不是Redis的瓶颈，Redis的瓶颈最有可能是机器内存的大小或者网络带宽。redis核心就是：如果我的数据全都在内存里，我单线程的去操作就是效率最高的，因为免去了线程之间的上下文切换开销。</p>
<br>

<h2 id="4-2-秒杀场景的redis使用"><a href="#4-2-秒杀场景的redis使用" class="headerlink" title="4.2 秒杀场景的redis使用"></a>4.2 秒杀场景的redis使用</h2><p>高并发场景，多个service线程。如果是mysql不加锁，必定会脏读，造成超卖，必定加锁同步，实际退化成所有service串行，加上前后其他业务逻辑，很慢。改用redis，单线程，本身就是串行化操作，通过decr进行商品数量减一</p>
<p><img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213046.png" alt=""></p>
<br>

<h2 id="4-3-strace追踪线程"><a href="#4-3-strace追踪线程" class="headerlink" title="4.3 strace追踪线程"></a>4.3 strace追踪线程</h2><p>strace可以追踪一个进程以及所有线程对操作系统的系统调用有哪些。比如是否使用了fork，是否使用了epoll，是否又创建了线程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install strace</span><br></pre></td></tr></table></figure>

<p>进入redis目录（src或者守护进程的都行）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace -ff -o /home/wjw/stracelog/out</span><br></pre></td></tr></table></figure>

<p>-ff表示监听fork系，第二个f表示包括线程</p>
<p>-o表示输出目录为/home/wjw/stracelog并以/out为前缀</p>
<p><img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213055.png" alt=""></p>
<p>可以进入/proc/3324/task目录下</p>
<p><img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213100.png" alt=""></p>
<p>这些是什么？<strong>3324是线程号，task代表任务，也就是开启了4个线程</strong></p>
<p>用vi或者gedit打开out.3324可以看到很多epoll相关的系统调用，因此redis的线程采用了epoll多路复用的技术</p>
<p><img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213105.png" alt=""></p>
<p>客户端输入bgsave，服务端3324线程开启了新的线程3829进行保存，使用clone系统调用，copy on write技术</p>
<p><img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213111.png" alt=""></p>
<p>查看strace的跟踪</p>
<p><img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213116.png" alt=""></p>
<br>

<hr>
<h1 id="5-缓存雪崩，穿透，击穿"><a href="#5-缓存雪崩，穿透，击穿" class="headerlink" title="5. 缓存雪崩，穿透，击穿"></a>5. 缓存雪崩，穿透，击穿</h1><p><strong>缓存雪崩</strong>：是说redis大量内容同时过期，因此db突然之间多了很多请求。解决方法就是随机过期时间</p>
<br>

<p><strong>缓存穿透</strong>：查询id=-1，第一次查db，查不到就不放进redis，第二次查一定不会在redis中，又去查db，如此往复…恶意发送大量查询请求，导致一直查db，就是缓存穿透。解决办法就是把-1: null存进redis，或者限制同一个key在一段时间的请求次数，或者是使用过滤器过滤掉</p>
<p>布隆过滤器：就是一个很长的bit数组，通过一级或者多级不同的hash函数之后将key转换成多个位的1，然后在bit数组上看是该key否存在，然后每次添加入redis时也会将这个key的hash位置为1。需要注意的地方有两个</p>
<ol>
<li>这里既然是Hash函数，那就存在一个问题，不存在的key也有可能经过hash函数之后对应位全为1，被误判为key存在，不过没关系。<strong>hash判断存在，key不一定存在。hash判断不存在，key一定不存在</strong></li>
<li>bit数组里面的位只能添加为1不能修改回0，因为改为0可能会影响多个key。所以要判断好这个数组的长度，否则经过多次置1后数组全为1，过滤器就失去了过滤意义，可以重新扩容。</li>
</ol>
<p>因为这些问题，后面还有其他的过滤器比如布谷鸟过滤器</p>
<br>

<p><strong>缓存击穿</strong>：跟缓存雪崩类似，是因为过期导致的，但是不是大量内容，而是说对同一个key发出大量的请求（比如秒杀），突然过期了，导致查db。这种场景解决办法就是查db的时候加锁，过期–&gt;加锁查db–&gt;db压力小–&gt;重新放进redis–&gt;查redis</p>
<br>

<hr>
<h1 id="6-Redis内存回收策略"><a href="#6-Redis内存回收策略" class="headerlink" title="6. Redis内存回收策略"></a>6. Redis内存回收策略</h1><p>两个方面：</p>
<ul>
<li>key过期时被删除</li>
<li>内存占用达到maxmemory触发内存溢出控制策略</li>
</ul>
<h2 id="6-1-删除过期key"><a href="#6-1-删除过期key" class="headerlink" title="6.1 删除过期key"></a>6.1 删除过期key</h2><p>redis不会实时监控每个key的过期时间并删除，而是采用<strong>惰性删除</strong>和<strong>定时任务删除</strong></p>
<ul>
<li><strong>惰性删除</strong>：过期的key并没有被直接删除，而是等到下一次访问的时候才删除。访问一个key，判断ttl，如果为0过期了，则删除并返回null，否则正常返回value。<strong>如果一直没有被访问，则会造成内存泄漏</strong></li>
<li><strong>定时任务删除</strong>：为了解决上述内存泄漏问题，redis每秒运行10次定时任务<ul>
<li>慢模式：随机检查20个键，过期则删除，过期超过25%，循环执行上述过程直到低于25%，超时时间为25ms</li>
<li>快模式：逻辑和快模式相同，只是超时时间不同。如果慢模式超时则先执行一次快模式，快模式下超时时间为1ms且2s内只能运行1次</li>
</ul>
</li>
</ul>
<br>

<h2 id="6-2-内存溢出控制策略"><a href="#6-2-内存溢出控制策略" class="headerlink" title="6.2 内存溢出控制策略"></a>6.2 内存溢出控制策略</h2><p>当Redis所用内存达到maxmemory上限时会触发相应的溢出控制策略。具体策略受maxmemory-policy参数控制，Redis支持6种策略，如下所示：</p>
<ol>
<li>noeviction：默认策略，当内存不足以容纳新写入数据时，新写入操作会报错。应该没人用吧。</li>
<li>allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的 Key。推荐使用，目前项目在用这种。</li>
<li>allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个 Key。应该也没人用吧，你不删最少使用 Key，去随机删。</li>
<li>volatile-lru：当内存不足以容纳新写入数据时，在<strong>设置了过期时间的键空间中</strong>，移除最近最少使用的 Key。这种情况一般是把 Redis 既当缓存，又做持久化存储的时候才用。不推荐。</li>
<li>volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个 Key。依然不推荐。</li>
<li>volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的 Key 优先移除。不推荐。如果没有对应的键，则回退到noeviction策略。</li>
</ol>
<blockquote>
<p>参考<br>作者：杨鑫科<br>链接：<a href="https://www.jianshu.com/p/6a5eb0ddf57b">https://www.jianshu.com/p/6a5eb0ddf57b</a><br>来源：简书</p>
</blockquote>
<br>

<hr>
<h1 id="7-Redis持久化"><a href="#7-Redis持久化" class="headerlink" title="7. Redis持久化"></a>7. Redis持久化</h1><p>redis存在内存中，服务器故障就造成了数据丢失，可以通过一些持久化策略来保护数据</p>
<h2 id="7-1-RDB（redis-database）"><a href="#7-1-RDB（redis-database）" class="headerlink" title="7.1 RDB（redis database）"></a>7.1 RDB（redis database）</h2><p>默认开启，将redis中的数据转换成二进制文件，调用save/bgsave/自动化时产生dump.rdb文件，适合全量备份。</p>
<ul>
<li>save：阻塞（调用时其他client的命令不能执行），覆盖（有旧的就替换）</li>
<li>bgsave：后台进行，原理是保存fork出来的副本，因此调用bgsave后即使修改了也不会被保存，因为副本没有变。也阻塞但阻塞的只是fork阶段，不阻塞客户端命令，缺点是需要消耗额外的内存</li>
<li>配置自动触发：redis.conf配置文件中设置save m n。表示m秒内数据集存在n次修改时，自动触发bgsave。</li>
</ul>
<p>rdb的三种触发方式都是保留了触发前最后一刻的状态，因此也称为快照</p>
<p>恢复：将dump.rdb放在redis安装目录（可以通过config get dir命令获取）并启动redis即可</p>
<br>

<h2 id="7-2-AOF（append-only-file）"><a href="#7-2-AOF（append-only-file）" class="headerlink" title="7.2 AOF（append only file）"></a>7.2 AOF（append only file）</h2><p>默认不开启，记录的是<strong>操作命令</strong>而不是内存数据，类似于日志文件。他不是记录每一步操作，而是调用bgrewriteaof命令时将当前内存中的数据生成命令的形式保存下来</p>
<p>也有三种触发方式</p>
<p>（1）每修改同步always：同步持久化 每次发生数据变更会被立即记录到磁盘 性能较差但数据完整性比较好</p>
<p>（2）每秒同步everysec：异步操作，每秒记录 如果一秒内宕机，有数据丢失</p>
<p>（3）no：从不同步</p>
<p>redis4.x之前开启了AOF就不用rdb了，4.x及以后用混合模式，恢复很快</p>
<br>

<hr>
<h1 id="8-高可用架构"><a href="#8-高可用架构" class="headerlink" title="8. 高可用架构"></a>8. 高可用架构</h1><p>主从架构+哨兵模式+集群</p>
<h2 id="8-1-主从架构"><a href="#8-1-主从架构" class="headerlink" title="8.1 主从架构"></a>8.1 主从架构</h2><p><strong>作用</strong></p>
<ul>
<li>读写分离：从机只读不可写，缓解了主机读压力，写从机会报错（you can’t write read only slave）</li>
<li>容灾恢复：从机会复制主机的数据，相当于备份(采用的是记录复制的偏移量的方式，可以断点续传 )</li>
<li>高可用：主机一挂，从机能升级为主机</li>
</ul>
<p><strong>配置方法</strong></p>
<ol>
<li><p>如果是同一台主机做实验，那么要修改redis.conf(默认为6379.conf)中的端口号、pid、日志名、rdb名(默认为dump.rdb，会覆盖)</p>
</li>
<li><p>查看角色命令为<code>info replication</code></p>
<p>主机会显示 role: master 并显示从机的ip和端口</p>
<p>从机会显示 role: slave 并显示主机ip和端口</p>
</li>
<li><p>从机执行命令<code>slaveof 主机ip 主机端口</code>并配置认证密码即可，主机无需配置</p>
</li>
</ol>
<p><strong>主从复制过程</strong></p>
<p>首先明白两个关键字</p>
<p>runid: master节点的唯一标识，每次启动时生成，可以通过<code>info server</code>查看</p>
<p>offset: slave需要从哪个位置开始同步数据(可以断点续传)</p>
<p><img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213126.png" alt="全量复制过程"></p>
<p>除了全量复制，还有部分复制，防止全量复制中因网络抖动而失去连接</p>
<p><img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717213139.png" alt="部分复制过程"></p>
<h2 id="8-2-哨兵模式"><a href="#8-2-哨兵模式" class="headerlink" title="8.2 哨兵模式"></a>8.2 哨兵模式</h2><p>哨兵就是用来监管各个机器的健康状态的，当主机宕机时，根据偏移量将某一台从机通过slaveof no one变成主机，其他主从机slaveof newIp newPort，哨兵可以帮我们自动完成这个过程。 </p>
<h2 id="8-3-Redis集群"><a href="#8-3-Redis集群" class="headerlink" title="8.3 Redis集群"></a>8.3 Redis集群</h2><p>redis3.0之后的新特性，主从复制还不能实现高可用，因为只分担了读压力，使用Redis Cluster，多个”节点”，每个节点都采用s主从架构，每个主节点都可以支持读写操作</p>
<p>每个节点负责的区域不同，数据是不一致的，要获取数据时必须先通过crc16算法再%16384得到对应的节点地址</p>
<p>后期新增节点可以进行hash迁移，潜移部分数据分担其他节点的压力</p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/algorithms/132-pattern/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">456-132模式</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/Mysql/mysql%E7%B4%A2%E5%BC%95/">
                <span class="level-item">mysql索引</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="valine-thread" class="content"></div>
<!-- <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script> -->
<script src="//code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js"></script>
<script>
    new Valine({
        el: '#valine-thread' ,
        notify: false,
        verify: false,
        app_id: 'JK6SpCImIdMNJd75JUpXY0ee-gzGzoHsz',
        app_key: 'Do5gvzKuVTiSa5Woy1bXzbYv',
        placeholder: '留下评论吧~'
    });
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="is-rounded" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717231547.jpeg" alt="wjwABCDEFG">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        wjwABCDEFG
                    </p>
                    
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Shaoguan, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            103
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            14
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            26
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/wjwABCDEFG" target="_blank" rel="noopener">
                关注我</a>
        </div>
        
        
        
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Java%E5%9F%BA%E7%A1%80/">
            <span class="level-start">
                <span class="level-item">Java基础</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">7</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Mysql/">
            <span class="level-start">
                <span class="level-item">Mysql</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Others/">
            <span class="level-start">
                <span class="level-item">Others</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Spring/">
            <span class="level-start">
                <span class="level-item">Spring</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/SpringCloud/">
            <span class="level-start">
                <span class="level-item">SpringCloud</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/util/">
            <span class="level-start">
                <span class="level-item">Util工具类</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/redis/">
            <span class="level-start">
                <span class="level-item">redis</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/frontend/">
            <span class="level-start">
                <span class="level-item">前端</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/algorithms/">
            <span class="level-start">
                <span class="level-item">数据结构和算法</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">60</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/games/">
            <span class="level-start">
                <span class="level-item">游戏和引擎</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/deeplearning/">
            <span class="level-start">
                <span class="level-item">玄学</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/life/">
            <span class="level-start">
                <span class="level-item">生活随笔</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/cs/">
            <span class="level-start">
                <span class="level-item">计算机基础</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/designpattern/">
            <span class="level-start">
                <span class="level-item">设计模式</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/DL-ML/" style="font-size: 10px;">DL/ML</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/lintcode/" style="font-size: 10px;">lintcode</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mysql/" style="font-size: 11.67px;">mysql</a> <a href="/tags/spring/" style="font-size: 11.67px;">spring</a> <a href="/tags/springcloud/" style="font-size: 10px;">springcloud</a> <a href="/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/" style="font-size: 10px;">二分查找</a> <a href="/tags/%E5%89%91%E6%8C%87offer/" style="font-size: 10px;">剑指offer</a> <a href="/tags/%E5%8A%9B%E6%89%A3/" style="font-size: 20px;">力扣</a> <a href="/tags/%E5%8A%A0%E5%AF%86/" style="font-size: 10px;">加密</a> <a href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" style="font-size: 13.33px;">动态规划</a> <a href="/tags/%E5%8D%95%E8%B0%83%E6%A0%88/" style="font-size: 15px;">单调栈</a> <a href="/tags/%E5%9B%9E%E6%BA%AF/" style="font-size: 16.67px;">回溯</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size: 10px;">字符串</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">学习记录</a> <a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 18.33px;">开发</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">排序</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.33px;">数据结构</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a> <a href="/tags/%E6%A0%91/" style="font-size: 15px;">树</a> <a href="/tags/%E6%B8%B8%E6%88%8F%E5%92%8C%E5%BC%95%E6%93%8E/" style="font-size: 11.67px;">游戏和引擎</a> <a href="/tags/%E7%AC%94%E8%AF%95/" style="font-size: 10px;">笔试</a> <a href="/tags/%E7%AC%94%E8%AF%95%E9%9D%A2%E8%AF%95/" style="font-size: 13.33px;">笔试面试</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">递归</a>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen is-sticky">
        
            

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    目录
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#1-数据存储和查找发展">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">1</span> -->
        <span>1. 数据存储和查找发展</span>
        </a></li><li>
        <a class="is-flex" href="#2-Redis特点">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">2</span> -->
        <span>2. Redis特点</span>
        </a></li><li>
        <a class="is-flex" href="#3-五种数据结构">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3</span> -->
        <span>3. 五种数据结构</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#String">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.1</span> -->
        <span>String</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#bitmap">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.1.1</span> -->
        <span>bitmap</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#Hash">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.2</span> -->
        <span>Hash</span>
        </a></li><li>
        <a class="is-flex" href="#List">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.3</span> -->
        <span>List</span>
        </a></li><li>
        <a class="is-flex" href="#Set">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.4</span> -->
        <span>Set</span>
        </a></li><li>
        <a class="is-flex" href="#Zset">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.5</span> -->
        <span>Zset</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#4-Redis的NIO和线程模型">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">4</span> -->
        <span>4. Redis的NIO和线程模型</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#4-1-为什么是单线程的">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">4.1</span> -->
        <span>4.1 为什么是单线程的</span>
        </a></li><li>
        <a class="is-flex" href="#4-2-秒杀场景的redis使用">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">4.2</span> -->
        <span>4.2 秒杀场景的redis使用</span>
        </a></li><li>
        <a class="is-flex" href="#4-3-strace追踪线程">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">4.3</span> -->
        <span>4.3 strace追踪线程</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#5-缓存雪崩，穿透，击穿">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">5</span> -->
        <span>5. 缓存雪崩，穿透，击穿</span>
        </a></li><li>
        <a class="is-flex" href="#6-Redis内存回收策略">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">6</span> -->
        <span>6. Redis内存回收策略</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#6-1-删除过期key">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">6.1</span> -->
        <span>6.1 删除过期key</span>
        </a></li><li>
        <a class="is-flex" href="#6-2-内存溢出控制策略">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">6.2</span> -->
        <span>6.2 内存溢出控制策略</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#7-Redis持久化">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">7</span> -->
        <span>7. Redis持久化</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#7-1-RDB（redis-database）">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">7.1</span> -->
        <span>7.1 RDB（redis database）</span>
        </a></li><li>
        <a class="is-flex" href="#7-2-AOF（append-only-file）">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">7.2</span> -->
        <span>7.2 AOF（append only file）</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#8-高可用架构">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">8</span> -->
        <span>8. 高可用架构</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#8-1-主从架构">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">8.1</span> -->
        <span>8.1 主从架构</span>
        </a></li><li>
        <a class="is-flex" href="#8-2-哨兵模式">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">8.2</span> -->
        <span>8.2 哨兵模式</span>
        </a></li><li>
        <a class="is-flex" href="#8-3-Redis集群">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">8.3</span> -->
        <span>8.3 Redis集群</span>
        </a></li></ul></li></ul>
            </div>
        </div>
    </div>

        
            <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            推荐阅读
        </h3>
        
        <article class="media">
            
            <a href="/Others/line-it-node-editor/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20250401154214355.jpeg" alt="Line-It 节点编辑器">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2025-04-01T07:28:20.000Z">2025-04-01</time></div>
                    <a href="/Others/line-it-node-editor/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Line-It 节点编辑器</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Others/">Others</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/games/Unity3D-note/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210728004637.jpg" alt="Unity3D学习笔记">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-07-28T12:42:07.000Z">2021-07-28</time></div>
                    <a href="/games/Unity3D-note/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Unity3D学习笔记</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/games/">游戏和引擎</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/life/%E4%B8%BA%E6%AF%95%E4%B8%9A%E5%81%9A%E5%87%86%E5%A4%87/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717225951.jpeg" alt="为毕业做准备">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-31T13:13:32.000Z">2021-03-31</time></div>
                    <a href="/life/%E4%B8%BA%E6%AF%95%E4%B8%9A%E5%81%9A%E5%87%86%E5%A4%87/" class="title has-link-black-ter is-size-6 has-text-weight-normal">为毕业做准备</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/life/">生活随笔</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/life/mhxy-experience/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717223725.png" alt="梦幻西游游戏体验">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-31T08:29:35.000Z">2021-03-31</time></div>
                    <a href="/life/mhxy-experience/" class="title has-link-black-ter is-size-6 has-text-weight-normal">梦幻西游游戏体验</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/life/">生活随笔</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/games/3DMath-Primerfor-Graphics-and-Game-Development-note/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717223435.jpeg" alt="3D数学基础图形与游戏研发笔记">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-06T10:55:07.000Z">2021-03-06</time></div>
                    <a href="/games/3DMath-Primerfor-Graphics-and-Game-Development-note/" class="title has-link-black-ter is-size-6 has-text-weight-normal">3D数学基础图形与游戏研发笔记</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/games/">游戏和引擎</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right is-sticky">
    
        

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    目录
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#1-数据存储和查找发展">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">1</span> -->
        <span>1. 数据存储和查找发展</span>
        </a></li><li>
        <a class="is-flex" href="#2-Redis特点">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">2</span> -->
        <span>2. Redis特点</span>
        </a></li><li>
        <a class="is-flex" href="#3-五种数据结构">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3</span> -->
        <span>3. 五种数据结构</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#String">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.1</span> -->
        <span>String</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#bitmap">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.1.1</span> -->
        <span>bitmap</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#Hash">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.2</span> -->
        <span>Hash</span>
        </a></li><li>
        <a class="is-flex" href="#List">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.3</span> -->
        <span>List</span>
        </a></li><li>
        <a class="is-flex" href="#Set">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.4</span> -->
        <span>Set</span>
        </a></li><li>
        <a class="is-flex" href="#Zset">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">3.5</span> -->
        <span>Zset</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#4-Redis的NIO和线程模型">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">4</span> -->
        <span>4. Redis的NIO和线程模型</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#4-1-为什么是单线程的">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">4.1</span> -->
        <span>4.1 为什么是单线程的</span>
        </a></li><li>
        <a class="is-flex" href="#4-2-秒杀场景的redis使用">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">4.2</span> -->
        <span>4.2 秒杀场景的redis使用</span>
        </a></li><li>
        <a class="is-flex" href="#4-3-strace追踪线程">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">4.3</span> -->
        <span>4.3 strace追踪线程</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#5-缓存雪崩，穿透，击穿">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">5</span> -->
        <span>5. 缓存雪崩，穿透，击穿</span>
        </a></li><li>
        <a class="is-flex" href="#6-Redis内存回收策略">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">6</span> -->
        <span>6. Redis内存回收策略</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#6-1-删除过期key">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">6.1</span> -->
        <span>6.1 删除过期key</span>
        </a></li><li>
        <a class="is-flex" href="#6-2-内存溢出控制策略">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">6.2</span> -->
        <span>6.2 内存溢出控制策略</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#7-Redis持久化">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">7</span> -->
        <span>7. Redis持久化</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#7-1-RDB（redis-database）">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">7.1</span> -->
        <span>7.1 RDB（redis database）</span>
        </a></li><li>
        <a class="is-flex" href="#7-2-AOF（append-only-file）">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">7.2</span> -->
        <span>7.2 AOF（append only file）</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#8-高可用架构">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">8</span> -->
        <span>8. 高可用架构</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#8-1-主从架构">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">8.1</span> -->
        <span>8.1 主从架构</span>
        </a></li><li>
        <a class="is-flex" href="#8-2-哨兵模式">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">8.2</span> -->
        <span>8.2 哨兵模式</span>
        </a></li><li>
        <a class="is-flex" href="#8-3-Redis集群">
        <!-- 目录是否自动编号 -->
        <!-- <span class="has-mr-6">8.3</span> -->
        <span>8.3 Redis集群</span>
        </a></li></ul></li></ul>
            </div>
        </div>
    </div>

    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            推荐阅读
        </h3>
        
        <article class="media">
            
            <a href="/Others/line-it-node-editor/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20250401154214355.jpeg" alt="Line-It 节点编辑器">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2025-04-01T07:28:20.000Z">2025-04-01</time></div>
                    <a href="/Others/line-it-node-editor/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Line-It 节点编辑器</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Others/">Others</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/games/Unity3D-note/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210728004637.jpg" alt="Unity3D学习笔记">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-07-28T12:42:07.000Z">2021-07-28</time></div>
                    <a href="/games/Unity3D-note/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Unity3D学习笔记</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/games/">游戏和引擎</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/life/%E4%B8%BA%E6%AF%95%E4%B8%9A%E5%81%9A%E5%87%86%E5%A4%87/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717225951.jpeg" alt="为毕业做准备">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-31T13:13:32.000Z">2021-03-31</time></div>
                    <a href="/life/%E4%B8%BA%E6%AF%95%E4%B8%9A%E5%81%9A%E5%87%86%E5%A4%87/" class="title has-link-black-ter is-size-6 has-text-weight-normal">为毕业做准备</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/life/">生活随笔</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/life/mhxy-experience/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717223725.png" alt="梦幻西游游戏体验">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-31T08:29:35.000Z">2021-03-31</time></div>
                    <a href="/life/mhxy-experience/" class="title has-link-black-ter is-size-6 has-text-weight-normal">梦幻西游游戏体验</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/life/">生活随笔</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/games/3DMath-Primerfor-Graphics-and-Game-Development-note/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717223435.jpeg" alt="3D数学基础图形与游戏研发笔记">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-06T10:55:07.000Z">2021-03-06</time></div>
                    <a href="/games/3DMath-Primerfor-Graphics-and-Game-Development-note/" class="title has-link-black-ter is-size-6 has-text-weight-normal">3D数学基础图形与游戏研发笔记</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/games/">游戏和引擎</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="images/loading.gif" data-original="https://cdn.jsdelivr.net/gh/wjwABCDEFG/blog_img/img/20210717231246.png" alt="redis基础" height="28">
                
                </a>
                <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备2026005630号-2</a >
                <p class="is-size-7">
                &copy; 2026 wjw&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                <br>
                <!-- <span id="busuanzi_container_site_uv">
                共<span id="busuanzi_value_site_uv">0</span>个访客
                </span> -->
                <span id="busuanzi_container_site_uv"> 来访 <span id="busuanzi_value_site_uv"></span>人</span>
                <span id="busuanzi_container_site_pv">, 总访问 <span id="busuanzi_value_site_pv"></span>次</span>

                <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
                    <script>
                        var now = new Date(); 
                        function createtime() { 
                            var grt= new Date("03/06/2020 00:00:00"); /*建站时间*/
                            now.setTime(now.getTime()+250); 
                            days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
                            hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
                            if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
                            mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
                            seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
                            snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
                            document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
                            document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
                        } 
                    setInterval("createtime()",250);
                    </script>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://wjw.today',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    

        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>